name: Fetch Banking News

on:
  schedule:
    # IST: 6am, 12pm, 6pm, 11pm (UTC: 0:30, 6:30, 12:30, 17:30)
    - cron: '30 0,6,12,17 * * *'
  workflow_dispatch: # Manual trigger button

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Fetch news from Claude and store in Supabase
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cat << 'SCRIPT' > fetch.mjs
          const today = new Date().toLocaleDateString('en-IN', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
            timeZone: 'Asia/Kolkata'
          });

          const sysPrompt = `You are "Banking Pulse" — like a sharp colleague who reads everything and catches you up over chai. Today is ${today}.

          Readers: Branch managers at Regional Rural Banks. Smart, busy, need the "so what" not just facts.

          VOICE RULES:
          - Write like you're explaining to a colleague, not writing a report
          - Lead every summary with WHY it matters, then the facts
          - "whyItMatters" should feel personal: "This means your MSME borrowers..." not "This impacts the banking sector"
          - Use parentheses to explain jargon: "MCLR (the rate your loans are linked to)"
          - Hindi should be natural spoken Hindi, not textbook: "ये आपके काम पर सीधा असर डालेगा" not "यह बैंकिंग क्षेत्र को प्रभावित करेगा"

          VOICE GUIDE FOR SUMMARIES:
          The summary should be 3-4 lines (not 2), lead with the key takeaway, use "you/your" language, and include at least one concrete implication for a branch manager at a Regional Rural Bank.
          BAD (news wire): "RBI maintained repo rate at 5.25% with neutral stance while bank MCLR rates dropped to 8.4% in January 2026. Fresh loan rates fell to 8.28% in December, making credit cheaper for borrowers."
          GOOD (sharp colleague): "RBI held the repo rate at 5.25% — no surprise there. But here's what matters: banks are cutting MCLR anyway, down to 8.4%. Your borrowers are about to get cheaper loans whether RBI moves or not."
          BAD: "The government has announced an increase in the agricultural credit target to ₹25 lakh crore for FY27."
          GOOD: "Big one for KCC portfolios — agri credit target just jumped to ₹25 lakh crore for FY27. If your branch has been slow on KCC sanctions, now's the time to push."

          MORNING BRIEF FORMAT:
          Format the morningBrief as an HTML string with clear sections:
          - Opening hook (1 line, bold): "<b>Big week — here's what you need to know before the morning meeting.</b>"
          - Then 4-6 bullet points in a <ul>, each one story/development in 1-2 punchy lines
          - Each bullet should start with a bold keyword/topic: "<li><b>Repo Rate:</b> Held at 5.25%, but MCLR cuts mean cheaper loans for your borrowers.</li>"
          - End with a closing line after the list
          The morningBriefHi should follow the same HTML structure but in natural spoken Hindi.

          Return 12-18 news items + 3-5 circulars.
          Categories: rbi, banking, msme, digital, rrb, markets, budget, nabard
          Importance: "must-read" (will change your branch operations), "good-to-know" (useful context), "fyi" (interesting but won't change your day)
          Badges: LATEST, BREAKING, ACTION NEEDED, GAME CHANGER, NEW, UPDATE, IMPORTANT, POLICY
          keyNumbers: Include 2-4 key numbers per story (rate, amount, date, count)

          TREND DATA:
          For 2-3 stories with rate/number changes across time, add a trendData object:
          If you can find 4+ data points over a meaningful time period (3+ months), return:
          {"trendData":{"metric":"MCLR Rate","points":[{"date":"Oct 25","value":8.71},{"date":"Nov 25","value":8.55},{"date":"Dec 25","value":8.28},{"date":"Jan 26","value":8.4}],"direction":"down","summary":"down 31 bps since Oct"}}
          If you cannot find 4+ reliable data points, return summary-only:
          {"trendData":{"metric":"MCLR Rate","points":[],"direction":"down","summary":"down 31 bps since Oct"}}
          NEVER return {"label":"","value":""} format — always use the trendData object format above.

          DEEP DIVE (only for "must-read" stories):
          For stories marked importance "must-read" ONLY (not good-to-know or fyi), generate a "deepDive" field (string, HTML allowed) containing a 2-3 paragraph concise explanation written like a knowledgeable colleague explaining over chai. Include:
          - What exactly happened and who announced it
          - Which specific banks/institutions are affected and historical context
          - What this means for YOUR branch specifically — be concrete: "check if your MCLR-linked loans have been repriced", "expect more KCC applications this quarter"
          - Any deadlines or dates to watch
          Voice: Conversational, specific, practical. Use "you/your" frequently. Keep it concise — 2-3 short paragraphs max.
          Wrap paragraphs in <p> tags and use <b> for key terms. Also generate "deepDiveHi" in natural spoken Hindi with the same HTML structure.
          For "good-to-know" and "fyi" stories, omit deepDive and deepDiveHi fields entirely.

          RESPOND IN VALID JSON ONLY:
          {"morningBrief":"<b>Hook line.</b><ul><li><b>Topic:</b> Detail.</li></ul>Bottom line.","morningBriefHi":"...","news":[{"id":"n1","category":"rbi","badge":"LATEST","importance":"must-read","title":"...","titleHi":"...","summary":"...","summaryHi":"...","whyItMatters":"...","whyItMattersHi":"...","deepDive":"<p>Detailed explanation...</p>","deepDiveHi":"<p>...</p>","keyNumbers":[{"label":"...","value":"..."}],"trendData":{"metric":"...","points":[{"date":"...","value":0}],"direction":"up|down|neutral","summary":"..."},"sources":[{"name":"...","url":"..."}],"date":"2026-02-22"}],"circulars":[{"id":"c1","issuer":"RBI","number":"...","date":"...","title":"...","titleHi":"...","summary":"...","summaryHi":"...","deadline":"...","actions":["Check if your branch...","Update your..."],"actionsHi":["..."],"url":"https://..."}]}

          CRITICAL: NO cite tags, NO [1] references. HTML is allowed ONLY in morningBrief, morningBriefHi, deepDive, and deepDiveHi fields. All other text fields must be clean plain text. Real source URLs. 12-18 news + 3-5 circulars.`;

          console.log('[fetch-news] Calling Claude API...');

          const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 32000,
              system: sysPrompt,
              tools: [{ type: 'web_search_20250305', name: 'web_search' }],
              messages: [{
                role: 'user',
                content: 'Search for latest Indian banking news + recent RBI/NABARD/DFS circulars. Include Hindi translations and trend data. 10-15 news + 3-5 circulars. Clean JSON only.'
              }],
            }),
          });

          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error?.message || 'API Error ' + resp.status);
          }

          console.log('[fetch-news] Parsing response...');

          const data = await resp.json();
          let txt = '';
          for (const b of data.content) {
            if (b.type === 'text') txt += b.text;
          }

          txt = txt.replace(/\`\`\`json\s*/g, '').replace(/\`\`\`\s*/g, '').trim();
          
          // Robust JSON extraction and repair (string-aware to handle HTML in values)
          let parsed;
          try {
            // Try direct parse first
            const match = txt.match(/\{[\s\S]*"news"[\s\S]*\}/);
            if (!match) throw new Error('No JSON found');
            parsed = JSON.parse(match[0]);
          } catch(e1) {
            console.log('[fetch-news] Direct parse failed, attempting repair...');
            try {
              // Find the JSON start
              const start = txt.indexOf('"morningBrief"');
              if (start === -1) throw new Error('Cannot find JSON start');
              let jsonStr = txt.substring(start - 1);
              const bracePos = jsonStr.lastIndexOf('{', 5);
              if (bracePos >= 0) jsonStr = jsonStr.substring(bracePos);
              else jsonStr = '{' + jsonStr;

              // String-aware brace counting (skip content inside quoted strings)
              let depth = 0, lastValid = 0, inStr = false, escape = false;
              for (let i = 0; i < jsonStr.length; i++) {
                const ch = jsonStr[i];
                if (escape) { escape = false; continue; }
                if (ch === '\\') { escape = true; continue; }
                if (ch === '"') { inStr = !inStr; continue; }
                if (inStr) continue;
                if (ch === '{' || ch === '[') depth++;
                if (ch === '}' || ch === ']') { depth--; if (depth === 0) { lastValid = i; break; } }
              }

              if (lastValid > 0) {
                jsonStr = jsonStr.substring(0, lastValid + 1);
              } else {
                // Truncated mid-string or mid-object — repair
                console.log('[fetch-news] JSON truncated, attempting string-aware repair...');
                // If we're inside a string, close it
                if (inStr) {
                  // Remove the partial string value and its key
                  jsonStr = jsonStr.replace(/,?\s*"[^"]*":\s*"[^"]*$/, '');
                  // If still broken, just truncate to last complete key-value
                  if (jsonStr.endsWith('"')) jsonStr += '""';
                }
                // Remove trailing incomplete objects/arrays
                jsonStr = jsonStr.replace(/,\s*\{[^{}]*$/, '');
                jsonStr = jsonStr.replace(/,\s*"[^"]*$/, '');
                // Re-count depth (string-aware) and close
                depth = 0; inStr = false; escape = false;
                const stack = [];
                for (let i = 0; i < jsonStr.length; i++) {
                  const ch = jsonStr[i];
                  if (escape) { escape = false; continue; }
                  if (ch === '\\') { escape = true; continue; }
                  if (ch === '"') { inStr = !inStr; continue; }
                  if (inStr) continue;
                  if (ch === '{') stack.push('}');
                  if (ch === '[') stack.push(']');
                  if (ch === '}' || ch === ']') stack.pop();
                }
                // Close any remaining open brackets/braces
                jsonStr = jsonStr.replace(/,\s*$/, '');
                jsonStr += stack.reverse().join('');
              }
              // Fix common JSON issues
              jsonStr = jsonStr.replace(/,\s*([}\]])/g, '$1'); // trailing commas
              parsed = JSON.parse(jsonStr);
            } catch(e2) {
              console.error('[fetch-news] JSON repair failed:', e2.message);
              console.error('[fetch-news] Raw text (first 1000 chars):', txt.substring(0, 1000));
              process.exit(1);
            }
          }
          
          if (!parsed.news || !Array.isArray(parsed.news)) {
            console.error('[fetch-news] Invalid format - no news array');
            process.exit(1);
          }
          
          console.log('[fetch-news] Parsed ' + parsed.news.length + ' news items');

          const clean = (t) => {
            if (!t) return '';
            return t
              .replace(/<\/?cite[^>]*>/gi, '')
              .replace(/<\/?antml:cite[^>]*>/gi, '')
              .replace(/<[^>]+>/g, '')
              .replace(/\[\d+(?:,\s*\d+)*\]/g, '')
              .replace(/\s+/g, ' ')
              .trim();
          };

          // Light clean: remove cite tags but preserve intentional HTML (for deepDive, morningBrief)
          const cleanHTML = (t) => {
            if (!t) return '';
            return t
              .replace(/<\/?cite[^>]*>/gi, '')
              .replace(/<\/?antml:cite[^>]*>/gi, '')
              .replace(/\[\d+(?:,\s*\d+)*\]/g, '')
              .trim();
          };

          parsed.news = parsed.news.map(n => {
            const td = n.trendData || null;
            return {
              ...n,
              title: clean(n.title),
              titleHi: clean(n.titleHi),
              summary: clean(n.summary),
              summaryHi: clean(n.summaryHi),
              whyItMatters: clean(n.whyItMatters),
              whyItMattersHi: clean(n.whyItMattersHi),
              deepDive: cleanHTML(n.deepDive),
              deepDiveHi: cleanHTML(n.deepDiveHi),
              importance: ['must-read','good-to-know','fyi'].includes(n.importance) ? n.importance : 'fyi',
              sources: (n.sources || []).map(s => ({ name: clean(s.name), url: s.url || '' })),
              keyNumbers: (n.keyNumbers || []).map(k => ({ label: clean(k.label), value: clean(k.value) })),
              trendData: td ? {
                metric: clean(td.metric),
                points: (td.points || []).map(p => ({ date: clean(p.date), value: p.value })),
                direction: td.direction || 'neutral',
                summary: clean(td.summary),
              } : null,
            };
          });

          const circulars = (parsed.circulars || []).map(c => ({
            ...c,
            title: clean(c.title), titleHi: clean(c.titleHi),
            summary: clean(c.summary), summaryHi: clean(c.summaryHi),
            actions: (c.actions || []).map(clean),
            actionsHi: (c.actionsHi || []).map(clean),
          }));

          const result = {
            morningBrief: cleanHTML(parsed.morningBrief || ''),
            morningBriefHi: cleanHTML(parsed.morningBriefHi || ''),
            news: parsed.news,
            circulars,
            fetchedAt: new Date().toISOString(),
          };

          console.log('[fetch-news] Storing in Supabase...');

          const sbResp = await fetch(process.env.SUPABASE_URL + '/rest/v1/news_cache', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': process.env.SUPABASE_SERVICE_KEY,
              'Authorization': 'Bearer ' + process.env.SUPABASE_SERVICE_KEY,
              'Prefer': 'resolution=merge-duplicates',
            },
            body: JSON.stringify({
              id: 'latest',
              data: result,
              updated_at: new Date().toISOString(),
            }),
          });

          if (!sbResp.ok) {
            const sbErr = await sbResp.text();
            throw new Error('Supabase error: ' + sbErr);
          }

          console.log('[fetch-news] Success: ' + parsed.news.length + ' news, ' + circulars.length + ' circulars');
          SCRIPT

          node --experimental-vm-modules fetch.mjs
