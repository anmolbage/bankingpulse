name: Fetch Banking News

on:
  schedule:
    # IST: 6am, 12pm, 6pm, 11pm (UTC: 0:30, 6:30, 12:30, 17:30)
    - cron: '30 0,6,12,17 * * *'
  workflow_dispatch: # Manual trigger button

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Fetch news from Claude and store in Supabase
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cat << 'SCRIPT' > fetch.mjs
          const today = new Date().toLocaleDateString('en-IN', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
            timeZone: 'Asia/Kolkata'
          });

          const sysPrompt = `You are "Banking Pulse" — the smartest, most well-read banking colleague in India. A branch official in a in india Bank has 5 minutes before their morning meeting. They trust you to tell them ONLY what actually matters. Today is ${today}.

          YOU ARE NOT A NEWS AGGREGATOR. Do not dump press releases. Think like an editor — what would a branch official forward to their WhatsApp group?

          CONTENT SELECTION PHILOSOPHY:
          - A routine NABARD refinance circular is NOT interesting. NABARD changing KCC guidelines IS.
          - An RBI form update is NOT interesting. RBI telling banks to stop mis-selling IS.
          - Prefer stories with CONSEQUENCES over mere ANNOUNCEMENTS.
          - If something changes how a branch operates, what a BM tells staff, or what customers will ask about — that is must-read.
          - If it is bureaucratic housekeeping, skip it. Do not include it even as fyi.
          - THE FRONT PAGE TEST: Would Economic Times or Business Standard put this on page 1? If yes, you MUST include it.
          - 8 great stories beat 15 mediocre ones. Never pad with filler.

          WHAT BRANCH MANAGERS CARE ABOUT:
          - Policy changes affecting daily ops (lending rates, KCC rules, NPA norms, compliance)
          - Big events (frauds over ₹100cr, mergers, FM/RBI Governor statements, stock crashes)
          - Things customers will ask about (govt schemes, deposit rates, loan eligibility)
          - Things their Regional Office will ask about (targets, audit, new reporting)
          - Competitive intel (what other banks are doing — digital launches, rate cuts)
          - Career updates (wage revision, JAIIB/CAIIB, promotion policy)

          WHAT THEY DO NOT CARE ABOUT:
          - Routine circulars with no operational impact
          - Generic macro commentary available everywhere
          - Repetitive stories (same topic as yesterday with no new development)
          - International banking unless it directly affects India
          - Self-congratulatory bank press releases

          VOICE RULES:
          - Write like you're explaining to a colleague over chai, not writing a report
          - Lead every summary with WHY it matters, then facts
          - "whyItMatters" must feel personal: "This means your MSME borrowers..." not "This impacts the banking sector"
          - Jargon in parentheses: "MCLR (the rate your loans are linked to)"
          - Hindi = natural spoken Hindi: "ये आपके काम पर सीधा असर डालेगा" not "यह बैंकिंग क्षेत्र को प्रभावित करेगा"
          - Summaries: 3-4 lines. Lead with key takeaway. Use "you/your". Include one concrete branch implication.
          GOOD: "RBI held repo at 5.25%. But banks are cutting MCLR anyway — your borrowers get cheaper loans whether RBI moves or not."
          GOOD: "Big one for KCC portfolios — agri credit target jumped to ₹25L cr. If your branch has been slow on KCC sanctions, push now."
          BAD: "RBI maintained repo rate at 5.25% with neutral stance while bank MCLR rates dropped."

          MORNING BRIEF FORMAT:
          HTML string, keep SHORT:
          - Bold opening hook: "<b>Big day — here's what you need to know.</b>"
          - 3-5 bullets in <ul>, each starting bold topic: "<li><b>IDFC Fraud:</b> ₹590cr scam at Chandigarh branch — staff colluded.</li>"
          - Short closing line
          morningBriefHi: same structure, natural spoken Hindi.
          morningBrief under 500 chars, morningBriefHi under 600 chars.

          FRESHNESS: Every story from last 24 hours only. No repeats from previous cycles unless major new development.
          DEDUPLICATION: Never two stories on same topic. Merge into one.

          Return 8-12 news + 2-3 circulars. KEEP TOTAL JSON under 15000 characters.
          Categories: rbi, banking, msme, digital, rrb, markets, budget, nabard
          Importance: "must-read" (changes branch operations), "good-to-know" (useful context), "fyi" (interesting)
          Badges: LATEST, BREAKING, ACTION NEEDED, GAME CHANGER, NEW, UPDATE, IMPORTANT, POLICY
          keyNumbers: 2-4 per story

          DIVERSITY RULE:
          - Max 3 RBI circular stories. Max 2 NABARD stories.
          - At least 2 general banking news (fraud, results, market moves)
          - At least 1 govt scheme or FM/policy story
          - At least 1 MSME/digital/fintech story

          TREND DATA (for at least 2 stories with rates/amounts changing):
          Even direction-only is fine: {"trendData":{"metric":"Repo Rate","points":[],"direction":"down","summary":"cut 25 bps to 6.25%"}}
          With data: {"trendData":{"metric":"MCLR","points":[{"date":"Oct 25","value":8.71},{"date":"Jan 26","value":8.4}],"direction":"down","summary":"down 31 bps"}}

          DEEP DIVE (first 2 must-read stories only):
          One paragraph, 3-4 sentences in <p> tag. What happened + concrete action.
          Example: "<p>RBI cut repo by 25 bps to 6.25%, first cut since 2020. Your MCLR-linked loans should reprice within the cycle. Check with HO if rates updated — borrowers will ask.</p>"
          Include deepDiveHi in Hindi. Omit for other stories.

          JSON STRUCTURE:
          {"morningBrief":"...","morningBriefHi":"...","news":[{...}],"circulars":[{...}]}
          News: id, category, badge, importance, title, titleHi, summary, summaryHi, whyItMatters, whyItMattersHi, keyNumbers[{label,value}], trendData (optional), sources[{name,url}], date, deepDive (optional), deepDiveHi (optional)
          Circulars: id, issuer, number, date, title, titleHi, summary, summaryHi, deadline, actions[], actionsHi[], url

          CRITICAL:
          - NO cite tags, NO [1] references
          - HTML only in morningBrief, morningBriefHi, deepDive, deepDiveHi
          - MUST include deepDive+deepDiveHi for first 2 must-reads
          - MUST include trendData for at least 2 stories
          - VALID JSON ONLY. No text before or after.`;

          console.log('[fetch-news] Calling Claude API...');

          const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 40000,
              system: sysPrompt,
              tools: [{ type: 'web_search_20250305', name: 'web_search', max_uses: 20 }],
              messages: [{
                role: 'user',
                content: `Search Indian banking news for ${today}. Run these searches IN ORDER:

1. HEADLINES FIRST: "Indian banking news today" — find what is making front pages right now
2. BIG EVENTS: "bank fraud India this week" + "finance minister banks RBI governor statement today"
3. POLICY: "RBI circular notification this week" + "RBI press release latest"
4. OPERATIONS: "MCLR rate cut banks" + "MSME lending credit India" + "KCC kisan credit card"
5. DIGITAL: "UPI digital payments fintech India latest"
6. GOVERNMENT: "government banking scheme India latest" + "PSB reform EASE DFS"
7. RRB SPECIFIC: "regional rural bank gramin bank" + "NABARD circular latest"
8. MACRO: "CPI inflation India" + "credit deposit ratio RBI data"

PRIORITY: If there is a major fraud (like IDFC First Bank ₹590cr), FM statement (like mis-selling warning), or RBI Governor comment in the news right now, those MUST be your top stories regardless of what else you find.

After searching, do a FINAL CHECK: What are the top 3 biggest Indian banking stories trending right now? Make sure they are included.

Return 8-12 news + 2-3 circulars. Deep dives for top 2 must-reads only. Total JSON under 15000 chars. VALID JSON only — no text before or after.`
              }],
            }),
          });

          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error?.message || 'API Error ' + resp.status);
          }

          console.log('[fetch-news] Parsing response...');

          const data = await resp.json();
          console.log('[fetch-news] Stop reason:', data.stop_reason, '| Output tokens:', data.usage?.output_tokens);
          if (data.stop_reason === 'max_tokens') {
            console.warn('[fetch-news] WARNING: Response was truncated (hit max_tokens). Will attempt repair.');
          }
          let txt = '';
          for (const b of data.content) {
            if (b.type === 'text') txt += b.text;
          }

          txt = txt.replace(/\`\`\`json\s*/g, '').replace(/\`\`\`\s*/g, '').trim();
          
          // Robust JSON extraction and repair (string-aware to handle HTML in values)
          let parsed;
          try {
            // Try direct parse first
            const match = txt.match(/\{[\s\S]*"news"[\s\S]*\}/);
            if (!match) throw new Error('No JSON found');
            parsed = JSON.parse(match[0]);
          } catch(e1) {
            console.log('[fetch-news] Direct parse failed, attempting repair...');
            try {
              // Find the JSON start
              const start = txt.indexOf('"morningBrief"');
              if (start === -1) throw new Error('Cannot find JSON start');
              let jsonStr = txt.substring(start - 1);
              const bracePos = jsonStr.lastIndexOf('{', 5);
              if (bracePos >= 0) jsonStr = jsonStr.substring(bracePos);
              else jsonStr = '{' + jsonStr;

              // String-aware brace counting (skip content inside quoted strings)
              let depth = 0, lastValid = 0, inStr = false, escape = false;
              for (let i = 0; i < jsonStr.length; i++) {
                const ch = jsonStr[i];
                if (escape) { escape = false; continue; }
                if (ch === '\\') { escape = true; continue; }
                if (ch === '"') { inStr = !inStr; continue; }
                if (inStr) continue;
                if (ch === '{' || ch === '[') depth++;
                if (ch === '}' || ch === ']') { depth--; if (depth === 0) { lastValid = i; break; } }
              }

              if (lastValid > 0) {
                jsonStr = jsonStr.substring(0, lastValid + 1);
              } else {
                // Truncated mid-string or mid-object — repair
                console.log('[fetch-news] JSON truncated, attempting string-aware repair...');
                // If we're inside a string, close it
                if (inStr) {
                  // Remove the partial string value and its key
                  jsonStr = jsonStr.replace(/,?\s*"[^"]*":\s*"[^"]*$/, '');
                  // If still broken, just truncate to last complete key-value
                  if (jsonStr.endsWith('"')) jsonStr += '""';
                }
                // Remove trailing incomplete objects/arrays
                jsonStr = jsonStr.replace(/,\s*\{[^{}]*$/, '');
                jsonStr = jsonStr.replace(/,\s*"[^"]*$/, '');
                // Re-count depth (string-aware) and close
                depth = 0; inStr = false; escape = false;
                const stack = [];
                for (let i = 0; i < jsonStr.length; i++) {
                  const ch = jsonStr[i];
                  if (escape) { escape = false; continue; }
                  if (ch === '\\') { escape = true; continue; }
                  if (ch === '"') { inStr = !inStr; continue; }
                  if (inStr) continue;
                  if (ch === '{') stack.push('}');
                  if (ch === '[') stack.push(']');
                  if (ch === '}' || ch === ']') stack.pop();
                }
                // Close any remaining open brackets/braces
                jsonStr = jsonStr.replace(/,\s*$/, '');
                jsonStr += stack.reverse().join('');
              }
              // Fix common JSON issues
              jsonStr = jsonStr.replace(/,\s*([}\]])/g, '$1'); // trailing commas
              parsed = JSON.parse(jsonStr);
            } catch(e2) {
              console.error('[fetch-news] JSON repair failed:', e2.message);
              console.error('[fetch-news] Raw text (first 1000 chars):', txt.substring(0, 1000));
              process.exit(1);
            }
          }
          
          if (!parsed.news || !Array.isArray(parsed.news)) {
            console.error('[fetch-news] Invalid format - no news array');
            process.exit(1);
          }
          
          console.log('[fetch-news] Parsed ' + parsed.news.length + ' news items');

          const clean = (t) => {
            if (!t) return '';
            return t
              .replace(/<\/?cite[^>]*>/gi, '')
              .replace(/<\/?antml:cite[^>]*>/gi, '')
              .replace(/<[^>]+>/g, '')
              .replace(/\[\d+(?:,\s*\d+)*\]/g, '')
              .replace(/\s+/g, ' ')
              .trim();
          };

          // Light clean: remove cite tags but preserve intentional HTML (for deepDive, morningBrief)
          const cleanHTML = (t) => {
            if (!t) return '';
            return t
              .replace(/<\/?cite[^>]*>/gi, '')
              .replace(/<\/?antml:cite[^>]*>/gi, '')
              .replace(/\[\d+(?:,\s*\d+)*\]/g, '')
              .trim();
          };

          parsed.news = parsed.news.map(n => {
            const td = n.trendData || null;
            return {
              ...n,
              title: clean(n.title),
              titleHi: clean(n.titleHi),
              summary: clean(n.summary),
              summaryHi: clean(n.summaryHi),
              whyItMatters: clean(n.whyItMatters),
              whyItMattersHi: clean(n.whyItMattersHi),
              deepDive: cleanHTML(n.deepDive),
              deepDiveHi: cleanHTML(n.deepDiveHi),
              importance: ['must-read','good-to-know','fyi'].includes(n.importance) ? n.importance : 'fyi',
              sources: (n.sources || []).map(s => ({ name: clean(s.name), url: s.url || '' })),
              keyNumbers: (n.keyNumbers || []).map(k => ({ label: clean(k.label), value: clean(k.value) })),
              trendData: td ? {
                metric: clean(td.metric),
                points: (td.points || []).map(p => ({ date: clean(p.date), value: p.value })),
                direction: td.direction || 'neutral',
                summary: clean(td.summary),
              } : null,
            };
          });

          const circulars = (parsed.circulars || []).map(c => ({
            ...c,
            title: clean(c.title), titleHi: clean(c.titleHi),
            summary: clean(c.summary), summaryHi: clean(c.summaryHi),
            actions: (c.actions || []).map(clean),
            actionsHi: (c.actionsHi || []).map(clean),
          }));

          const result = {
            morningBrief: cleanHTML(parsed.morningBrief || ''),
            morningBriefHi: cleanHTML(parsed.morningBriefHi || ''),
            news: parsed.news,
            circulars,
            fetchedAt: new Date().toISOString(),
          };

          console.log('[fetch-news] Storing in Supabase...');

          const sbResp = await fetch(process.env.SUPABASE_URL + '/rest/v1/news_cache', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': process.env.SUPABASE_SERVICE_KEY,
              'Authorization': 'Bearer ' + process.env.SUPABASE_SERVICE_KEY,
              'Prefer': 'resolution=merge-duplicates',
            },
            body: JSON.stringify({
              id: 'latest',
              data: result,
              updated_at: new Date().toISOString(),
            }),
          });

          if (!sbResp.ok) {
            const sbErr = await sbResp.text();
            throw new Error('Supabase error: ' + sbErr);
          }

          console.log('[fetch-news] Success: ' + parsed.news.length + ' news, ' + circulars.length + ' circulars');
          SCRIPT

          node --experimental-vm-modules fetch.mjs
