name: Fetch Banking News

on:
  schedule:
    # IST: 6am, 12pm, 6pm, 11pm (UTC: 0:30, 6:30, 12:30, 17:30)
    - cron: '30 0,6,12,17 * * *'
  workflow_dispatch: # Manual trigger button

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Fetch news from Claude and store in Supabase
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cat << 'SCRIPT' > fetch.mjs
          const today = new Date().toLocaleDateString('en-IN', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
            timeZone: 'Asia/Kolkata'
          });

          const sysPrompt = `You are "Banking Pulse" — like a sharp colleague who reads everything and catches you up over chai. Today is ${today}.

          Readers: Branch managers at Regional Rural Banks. Smart, busy, need the "so what" not just facts.

          VOICE RULES:
          - Write like you're explaining to a colleague, not writing a report
          - Lead every summary with WHY it matters, then the facts
          - "whyItMatters" should feel personal: "This means your MSME borrowers..." not "This impacts the banking sector"
          - Use parentheses to explain jargon: "MCLR (the rate your loans are linked to)"
          - Hindi should be natural spoken Hindi, not textbook: "ये आपके काम पर सीधा असर डालेगा" not "यह बैंकिंग क्षेत्र को प्रभावित करेगा"

          VOICE GUIDE FOR SUMMARIES:
          ❌ DONT: "RBI maintained repo rate at 5.25% with neutral stance while bank MCLR rates dropped to 8.4% in January 2026."
          ✅ DO: "RBI held the repo rate at 5.25% — no surprise there. But here is what matters: banks are cutting MCLR anyway, down to 8.4%. Your borrowers are about to get cheaper loans whether RBI moves or not."
          ❌ DONT: "The government has announced an increase in the agricultural credit target to 25 lakh crore for FY27."
          ✅ DO: "Big one for KCC portfolios — agri credit target just jumped to 25 lakh crore for FY27. If your branch has been slow on KCC sanctions, now is the time to push."
          Summaries should be 3-4 lines, lead with the key takeaway, use you/your language, and include one concrete implication for a branch manager at a Regional Rural Bank.

          MORNING BRIEF FORMAT:
          Format morningBrief with a bold opening hook, then 4-6 bullet points each starting with a bold topic keyword. Example: "<b>MCLR Cuts:</b> Major banks cutting rates by 5-30 bps — cheaper loans ahead for your borrowers." End with a one-line bottom line.
          The morningBriefHi should follow the same HTML structure but in natural spoken Hindi. Keep morningBrief under 400 characters and morningBriefHi under 500 characters.

          Return 8-10 news items + 2-3 circulars. KEEP TOTAL RESPONSE SHORT — under 12000 characters of JSON.
          Categories: rbi, banking, msme, digital, rrb, markets, budget, nabard

          DIVERSITY RULE: Your 8-10 stories MUST include:
          - Max 3 stories from RBI circulars/notifications
          - Max 2 stories from NABARD
          - At least 2 stories from general banking news (fraud, mergers, quarterly results, market moves)
          - At least 1 government scheme or policy story
          - At least 1 MSME/digital/fintech story
          If a major event happened today (large fraud, bank failure, major policy announcement, FM/RBI Governor statement), it MUST be included as must-read even if it means dropping a routine circular.
          PRIORITY OVERRIDE: Breaking news and high-impact events (fraud over 100 crore, RBI Governor statements, FM directives to banks, bank stock crashes) always take priority over routine circulars and notifications. A 590 crore fraud at a bank is more important than a routine NABARD refinance circular.
          Importance: "must-read" (will change your branch operations), "good-to-know" (useful context), "fyi" (interesting but won't change your day)
          Badges: LATEST, BREAKING, ACTION NEEDED, GAME CHANGER, NEW, UPDATE, IMPORTANT, POLICY
          keyNumbers: Include 2-4 key numbers per story (rate, amount, date, count)

          TREND DATA (REQUIRED for at least 2 stories):
          You MUST include trendData for at least 2 news items that involve rates, amounts, or counts changing over time.
          Provide trendData ONLY if you can find 4+ data points over 3+ months. Format as: {"metric":"string","points":[{"date":"string","value":number}],"direction":"up/down/stable","summary":"string"}.
          If fewer than 4 data points exist, return: {"metric":"string","points":[],"direction":"string","summary":"string"} with just the summary text like "MCLR down 31 bps since Oct".
          NEVER return empty label/value objects like {"label":"","value":""}.

          DEEP DIVE (REQUIRED for every story):
          For each story, generate a "deepDive" field containing a 4-6 paragraph HTML explanation. Write like a knowledgeable colleague explaining over chai. Include: what exactly happened, which banks/institutions are affected, what was the rule/rate before, what this means for YOUR branch specifically with concrete actions, any deadlines to watch. Use you/your language. Explain jargon in parentheses.
          Wrap each paragraph in <p> tags. Also include "deepDiveHi" in Hindi with same structure.

          RESPOND IN VALID JSON ONLY. Structure:
          {"morningBrief":"...","morningBriefHi":"...","news":[{...}],"circulars":[{...}]}
          News fields: id, category, badge, importance, title, titleHi, summary, summaryHi, whyItMatters, whyItMattersHi, keyNumbers[{label,value}], trendData (optional), sources[{name,url}], date, deepDive, deepDiveHi
          Circular fields: id, issuer, number, date, title, titleHi, summary, summaryHi, deadline, actions[], actionsHi[], url

          CRITICAL RULES:
          - NO cite tags, NO [1] references
          - HTML allowed ONLY in morningBrief, morningBriefHi, deepDive, deepDiveHi
          - 8-10 news + 2-3 circulars. BE CONCISE.
          - MUST include deepDive + deepDiveHi for every news item (4-6 paragraphs each)
          - MUST include trendData for at least 2 news items (use full points array if 4+ data points available, otherwise include direction + summary only)
          - Summaries must sound like a colleague talking, NOT a news wire. Use "you/your" and be specific about branch impact.`;

          console.log('[fetch-news] Calling Claude API...');

          const resp = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 40000,
              system: sysPrompt,
              tools: [{ type: 'web_search_20250305', name: 'web_search', max_uses: 5 }],
              messages: [{
                role: 'user',
                content: `Search using these mandatory queries (run breaking news queries FIRST):
          1. Indian bank fraud scandal breaking news today
          2. finance minister banks RBI governor statement today
          3. Indian banking news today
          4. RBI circular notification today
          5. NABARD circular latest
          6. MSME lending credit India latest
          7. digital payments UPI fintech India
          8. regional rural bank gramin bank news
          9. Indian bank fraud investigation latest
          10. RBI repo rate MCLR interest rate
          11. government banking scheme India latest
          12. PSB public sector bank reform EASE
          13. KCC kisan credit card agricultural credit
          14. CPI inflation GDP India data
          15. bank mis-selling RBI guidelines

          Prioritize results from: rbi.org.in, pib.gov.in, nabard.org, financialservices.gov.in as primary sources.

          Also search for recent RBI/NABARD/DFS circulars. Include Hindi translations and trend data. 8-10 news + 2-3 circulars. Keep summaries short (2-3 lines). Include deepDive (4-6 paragraphs) for every story. Clean JSON only — no extra text before or after.`
              }],
            }),
          });

          if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.error?.message || 'API Error ' + resp.status);
          }

          console.log('[fetch-news] Parsing response...');

          const data = await resp.json();
          console.log('[fetch-news] Stop reason:', data.stop_reason, '| Output tokens:', data.usage?.output_tokens);
          if (data.stop_reason === 'max_tokens') {
            console.warn('[fetch-news] WARNING: Response was truncated (hit max_tokens). Will attempt repair.');
          }
          let txt = '';
          for (const b of data.content) {
            if (b.type === 'text') txt += b.text;
          }

          txt = txt.replace(/\`\`\`json\s*/g, '').replace(/\`\`\`\s*/g, '').trim();
          
          // Robust JSON extraction and repair (string-aware to handle HTML in values)
          let parsed;
          try {
            // Try direct parse first
            const match = txt.match(/\{[\s\S]*"news"[\s\S]*\}/);
            if (!match) throw new Error('No JSON found');
            parsed = JSON.parse(match[0]);
          } catch(e1) {
            // Fallback: strip markdown fences, find first { and last }
            console.log('[fetch-news] Direct parse failed, trying brace extraction...');
            try {
              const stripped = txt.replace(/\`\`\`json\s*/g, '').replace(/\`\`\`\s*/g, '').trim();
              const firstBrace = stripped.indexOf('{');
              const lastBrace = stripped.lastIndexOf('}');
              if (firstBrace === -1 || lastBrace <= firstBrace) throw new Error('No JSON braces found');
              parsed = JSON.parse(stripped.substring(firstBrace, lastBrace + 1));
            } catch(e1b) {
            console.log('[fetch-news] Brace extraction failed, attempting repair...');
            try {
              // Find the JSON start
              const start = txt.indexOf('"morningBrief"');
              if (start === -1) throw new Error('Cannot find JSON start');
              let jsonStr = txt.substring(start - 1);
              const bracePos = jsonStr.lastIndexOf('{', 5);
              if (bracePos >= 0) jsonStr = jsonStr.substring(bracePos);
              else jsonStr = '{' + jsonStr;

              // String-aware brace counting (skip content inside quoted strings)
              let depth = 0, lastValid = 0, inStr = false, escape = false;
              for (let i = 0; i < jsonStr.length; i++) {
                const ch = jsonStr[i];
                if (escape) { escape = false; continue; }
                if (ch === '\\') { escape = true; continue; }
                if (ch === '"') { inStr = !inStr; continue; }
                if (inStr) continue;
                if (ch === '{' || ch === '[') depth++;
                if (ch === '}' || ch === ']') { depth--; if (depth === 0) { lastValid = i; break; } }
              }

              if (lastValid > 0) {
                jsonStr = jsonStr.substring(0, lastValid + 1);
              } else {
                // Truncated mid-string or mid-object — repair
                console.log('[fetch-news] JSON truncated, attempting string-aware repair...');
                // If we're inside a string, close it
                if (inStr) {
                  // Remove the partial string value and its key
                  jsonStr = jsonStr.replace(/,?\s*"[^"]*":\s*"[^"]*$/, '');
                  // If still broken, just truncate to last complete key-value
                  if (jsonStr.endsWith('"')) jsonStr += '""';
                }
                // Remove trailing incomplete objects/arrays
                jsonStr = jsonStr.replace(/,\s*\{[^{}]*$/, '');
                jsonStr = jsonStr.replace(/,\s*"[^"]*$/, '');
                // Re-count depth (string-aware) and close
                depth = 0; inStr = false; escape = false;
                const stack = [];
                for (let i = 0; i < jsonStr.length; i++) {
                  const ch = jsonStr[i];
                  if (escape) { escape = false; continue; }
                  if (ch === '\\') { escape = true; continue; }
                  if (ch === '"') { inStr = !inStr; continue; }
                  if (inStr) continue;
                  if (ch === '{') stack.push('}');
                  if (ch === '[') stack.push(']');
                  if (ch === '}' || ch === ']') stack.pop();
                }
                // Close any remaining open brackets/braces
                jsonStr = jsonStr.replace(/,\s*$/, '');
                jsonStr += stack.reverse().join('');
              }
              // Fix common JSON issues
              jsonStr = jsonStr.replace(/,\s*([}\]])/g, '$1'); // trailing commas
              parsed = JSON.parse(jsonStr);
            } catch(e2) {
              console.error('[fetch-news] JSON repair failed:', e2.message);
              console.error('[fetch-news] Raw response length:', txt.length);
              console.error('[fetch-news] Raw text (first 1000 chars):', txt.substring(0, 1000));
              process.exit(1);
            }
            }
          }
          
          if (!parsed.news || !Array.isArray(parsed.news)) {
            console.error('[fetch-news] Invalid format - no news array');
            process.exit(1);
          }
          
          console.log('[fetch-news] Parsed ' + parsed.news.length + ' news items');

          const clean = (t) => {
            if (!t) return '';
            return t
              .replace(/<\/?cite[^>]*>/gi, '')
              .replace(/<\/?antml:cite[^>]*>/gi, '')
              .replace(/<[^>]+>/g, '')
              .replace(/\[\d+(?:,\s*\d+)*\]/g, '')
              .replace(/\s+/g, ' ')
              .trim();
          };

          // Light clean: remove cite tags but preserve intentional HTML (for deepDive, morningBrief)
          const cleanHTML = (t) => {
            if (!t) return '';
            return t
              .replace(/<\/?cite[^>]*>/gi, '')
              .replace(/<\/?antml:cite[^>]*>/gi, '')
              .replace(/\[\d+(?:,\s*\d+)*\]/g, '')
              .trim();
          };

          parsed.news = parsed.news.map(n => {
            const td = n.trendData || null;
            return {
              ...n,
              title: clean(n.title),
              titleHi: clean(n.titleHi),
              summary: clean(n.summary),
              summaryHi: clean(n.summaryHi),
              whyItMatters: clean(n.whyItMatters),
              whyItMattersHi: clean(n.whyItMattersHi),
              deepDive: cleanHTML(n.deepDive),
              deepDiveHi: cleanHTML(n.deepDiveHi),
              importance: ['must-read','good-to-know','fyi'].includes(n.importance) ? n.importance : 'fyi',
              sources: (n.sources || []).map(s => ({ name: clean(s.name), url: s.url || '' })),
              keyNumbers: (n.keyNumbers || []).map(k => ({ label: clean(k.label), value: clean(k.value) })),
              trendData: td ? {
                metric: clean(td.metric),
                points: (td.points || []).map(p => ({ date: clean(p.date), value: p.value })),
                direction: td.direction || 'neutral',
                summary: clean(td.summary),
              } : null,
            };
          });

          const circulars = (parsed.circulars || []).map(c => ({
            ...c,
            title: clean(c.title), titleHi: clean(c.titleHi),
            summary: clean(c.summary), summaryHi: clean(c.summaryHi),
            actions: (c.actions || []).map(clean),
            actionsHi: (c.actionsHi || []).map(clean),
          }));

          const result = {
            morningBrief: cleanHTML(parsed.morningBrief || ''),
            morningBriefHi: cleanHTML(parsed.morningBriefHi || ''),
            news: parsed.news,
            circulars,
            fetchedAt: new Date().toISOString(),
          };

          console.log('[fetch-news] Storing in Supabase...');

          const sbResp = await fetch(process.env.SUPABASE_URL + '/rest/v1/news_cache', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': process.env.SUPABASE_SERVICE_KEY,
              'Authorization': 'Bearer ' + process.env.SUPABASE_SERVICE_KEY,
              'Prefer': 'resolution=merge-duplicates',
            },
            body: JSON.stringify({
              id: 'latest',
              data: result,
              updated_at: new Date().toISOString(),
            }),
          });

          if (!sbResp.ok) {
            const sbErr = await sbResp.text();
            throw new Error('Supabase error: ' + sbErr);
          }

          console.log('[fetch-news] Success: ' + parsed.news.length + ' news, ' + circulars.length + ' circulars');
          SCRIPT

          node --experimental-vm-modules fetch.mjs
